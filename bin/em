#!/usr/bin/env sh

if [ "$(uname -s)" = "Darwin" ]; then
  # shellcheck source=/dev/null
  . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
fi

if ! command -v emacsclient >/dev/null 2>&1 || ! pgrep emacs >/dev/null 2>&1; then
  echo "No emacsclient, falling back to editor"
  exec ~/.dotfiles/bin/editor "$@"
fi

unset TMPDIR

if [ -z "$INSIDE_EMACS" ] && [ -n "$DISPLAY" ]; then
  args="--create-frame"

  if [ -z "$IS_EDITOR" ]; then
    args="$args --no-wait"
  fi
else
  if [ -z "$INSIDE_EMACS" ]; then
    args="--tty"
  elif [ -z "$IS_EDITOR" ]; then
    args="$args --no-wait"
  fi
fi

if [ "$(emacsclient -e "(getenv \"SSH_AUTH_SOCK\")")" != "$SSH_AUTH_SOCK" ]; then
    echo "Updating SSH_AUTH_SOCK"
    emacsclient -e "(setenv \"SSH_AUTH_SOCK\" \"$SSH_AUTH_SOCK\")" > /dev/null
fi

exec emacsclient "$args" "$@"

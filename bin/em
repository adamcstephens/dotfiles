#!/usr/bin/env sh

if [ "$(uname -s)" = "Darwin" ]; then
  source /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
fi

if ! command -v emacsclient >/dev/null 2>&1; then
  echo "No emacsclient, falling back to editor"
  exec ~/.dotfiles/bin/editor $@
fi

OLDTERM=$TERM

unset TMPDIR

if [ ! -e ~/.config/systemd/user/emacs.service ]; then
  case $(uname -s) in
  Darwin)
    pgrep -i emacs >/dev/null 2>&1
    rc=$?
    ;;
  *)
    pgrep emacs >/dev/null 2>&1
    rc=$?
    ;;
  esac
  [ $rc -eq 0 ] || emacs
fi

if [ -e /etc/profiles/per-user/$USER/share/terminfo/x/xterm-emacs ] || [ -e ~/.nix-profile/share/terminfo/x/xterm-emacs ] || [ -e ~/.terminfo/x/xterm-emacs ] || [ -e ~/.terminfo/78/xterm-emacs ]; then
  export TERM=xterm-emacs
else
  export TERM=xterm-256color
fi

if [ -n "$DISPLAY" ] || [ "$(uname -s)" = "Darwin" ]; then
  emacsclient --create-frame --no-wait "$@"
else
  emacsclient --tty "$@"
fi

# shellcheck disable=SC2086
export TERM=$OLDTERM
